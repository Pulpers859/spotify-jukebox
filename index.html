<script>
  // ==========================
  // Funcleson Jukebox (Last.fm-only)
  // Spotify plays anywhere → Finale scrobbles → Last.fm feeds this board
  // ==========================

  // ===== Last.fm CONFIG =====
  const LASTFM_USER = "funcleson";
  const LASTFM_API_KEY = "529379aa6bef76cade9e86686d64e75f";
  const POLL_MS = 6500; // refresh cadence

  // ===== UI =====
  const themeButton  = document.getElementById("themeButton");
  const themeLabelEl = document.getElementById("themeLabel");

  const trackNameEl = document.getElementById("trackName");
  const artistNameEl = document.getElementById("artistName");
  const statusTextEl = document.getElementById("statusText");
  const placeholderHintEl = document.getElementById("placeholderHint");

  const albumArtEl = document.getElementById("albumArt");
  const albumPlaceholderEl = document.getElementById("albumPlaceholder");
  const albumImgEl = document.getElementById("albumImg");
  const eqBars = Array.from(document.querySelectorAll(".eq-bar"));

  // ===== Silk portrait detection =====
  function applyForcePortrait(){
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    document.documentElement.classList.toggle("force-portrait", vw > vh);
  }
  window.addEventListener("resize", applyForcePortrait);
  window.addEventListener("orientationchange", applyForcePortrait);

  // ===== Theme switcher =====
  const THEMES = {
    cozy:    { label: "Cozy" },
    vintage: { label: "Vintage Neon" },
    taproom: { label: "Taproom" }
  };

  function setTheme(themeKey, { persist = true } = {}) {
    const t = THEMES[themeKey] ? themeKey : "cozy";
    document.documentElement.dataset.theme = t;
    themeLabelEl.textContent = `Theme: ${THEMES[t].label}`;
    if (persist) localStorage.setItem("jukebox_theme", t);
  }

  function initTheme(){
    const params = new URLSearchParams(location.search);
    const fromUrl = params.get("theme");
    const fromStorage = localStorage.getItem("jukebox_theme");
    setTheme(fromUrl || fromStorage || "cozy", { persist: !fromUrl });
  }

  function toggleTheme(){
    const order = ["cozy","vintage","taproom"];
    const current = document.documentElement.dataset.theme || "cozy";
    const idx = order.indexOf(current);
    setTheme(order[(idx + 1) % order.length]);
  }

  // ===== EQ =====
  let eqInterval = null;
  function animateEqBars(isPlaying){
    eqBars.forEach(bar => {
      if (!isPlaying){
        bar.style.transform = "scaleY(0.25)";
        return;
      }
      const scale = 0.25 + Math.random() * 0.85;
      bar.style.transform = `scaleY(${scale.toFixed(2)})`;
    });
  }
  function startEq(){
    if (eqInterval) return;
    eqInterval = setInterval(() => animateEqBars(true), 320);
  }
  function stopEq(){
    if (eqInterval){
      clearInterval(eqInterval);
      eqInterval = null;
    }
    animateEqBars(false);
  }

  // ===== Unified renderer =====
  function renderNowPlaying({ trackName, artistName, artworkUrl, isPlaying, status, hint }){
    trackNameEl.textContent = trackName || "—";
    artistNameEl.textContent = artistName || "—";

    if (artworkUrl){
      albumImgEl.src = artworkUrl;
      albumImgEl.alt = `${trackName || ""} - ${artistName || ""}`.trim();
      albumImgEl.style.display = "block";
      albumPlaceholderEl.style.display = "none";
    } else {
      albumImgEl.removeAttribute("src");
      albumImgEl.style.display = "none";
      albumPlaceholderEl.style.display = "flex";
    }

    if (hint) placeholderHintEl.textContent = hint;

    statusTextEl.textContent = status || (isPlaying ? "Playing" : "Paused");

    if (isPlaying){
      albumArtEl.classList.add("playing");
      startEq();
    } else {
      albumArtEl.classList.remove("playing");
      stopEq();
    }
  }

  function showNothingPlaying(message, hint){
    renderNowPlaying({
      trackName: "—",
      artistName: "—",
      artworkUrl: "",
      isPlaying: false,
      status: message || "No active playback.",
      hint: hint || "Start Spotify on any device (Finale → Last.fm)"
    });
  }

  // ===== Helpers =====
  function encodeTerm(s){ return encodeURIComponent((s || "").trim()); }

  async function fetchItunesArtwork(trackName, artistName){
    try{
      const term = `${trackName} ${artistName}`.trim();
      const url = `https://itunes.apple.com/search?term=${encodeTerm(term)}&limit=1&media=music`;
      const res = await fetch(url, { cache: "no-store" });
      const data = await res.json();
      const art = data?.results?.[0]?.artworkUrl100;
      if (!art) return "";
      return art.replace(/100x100/g, "600x600");
    } catch {
      return "";
    }
  }

  // ===== Last.fm polling =====
  async function fetchLastFmNowPlaying(){
    const url =
      `https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks` +
      `&user=${encodeTerm(LASTFM_USER)}` +
      `&api_key=${encodeTerm(LASTFM_API_KEY)}` +
      `&limit=1&format=json`;

    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Last.fm HTTP ${res.status}`);
    const data = await res.json();

    const track = data?.recenttracks?.track?.[0];
    if (!track) return null;

    const trackName = track?.name || "—";
    const artistName = track?.artist?.["#text"] || "—";
    const nowPlaying = track?.["@attr"]?.nowplaying === "true";

    const lastfmImg =
      track?.image?.slice?.(-1)?.[0]?.["#text"] ||
      track?.image?.find?.(i => i.size === "extralarge")?.["#text"] ||
      "";

    const artworkUrl = lastfmImg || await fetchItunesArtwork(trackName, artistName);

    return {
      trackName,
      artistName,
      artworkUrl: artworkUrl || "",
      isPlaying: nowPlaying,
      status: "Spotify (via Last.fm)",
      hint: "Start Spotify on any device (Finale → Last.fm)"
    };
  }

  let pollInterval = null;

  async function tick(){
    try{
      const info = await fetchLastFmNowPlaying();
      if (!info){
        showNothingPlaying("No recent scrobbles yet.", "Start Spotify on any device (Finale → Last.fm)");
        return;
      }

      // If Last.fm says "not nowplaying", we still show the last track,
      // but pause the EQ/wave so it doesn't look like it's actively playing.
      renderNowPlaying(info);

      // If it's NOT actively playing, keep the status but stop animation.
      if (!info.isPlaying){
        albumArtEl.classList.remove("playing");
        stopEq();
        statusTextEl.textContent = "Last scrobble (not live playback)";
      }
    } catch (e){
      console.error("Last.fm tick error:", e);
      showNothingPlaying("Connection hiccup. Retrying…", "Start Spotify on any device (Finale → Last.fm)");
    }
  }

  function startPolling(){
    if (pollInterval) return;
    pollInterval = setInterval(tick, POLL_MS);
    tick();
  }

  function stopPolling(){
    if (pollInterval){
      clearInterval(pollInterval);
      pollInterval = null;
    }
  }

  // ===== init =====
  (function init(){
    applyForcePortrait();
    initTheme();

    themeButton.addEventListener("click", toggleTheme);

    // initial UI state
    showNothingPlaying("Waiting for scrobbles…", "Start Spotify on any device (Finale → Last.fm)");

    // go
    startPolling();

    // Optional: pause polling when tab hidden (Silk can be weird; safe either way)
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        // Keep polling in Silk if you prefer; comment these 2 lines out to keep always-on.
        stopPolling();
        stopEq();
      } else {
        startPolling();
      }
    });
  })();
</script>
